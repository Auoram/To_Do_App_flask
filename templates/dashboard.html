{% extends 'layout.html' %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-8 p-6 bg-green-500">
  <h1 class="text-4xl font-extrabold text-white">Welcome to Your Dashboard</h1>
  <form action="/logout" method="POST">
    <button class="bg-green-700 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">Logout</button>
  </form>
</div>
<div class="container px-6 mx-auto py-6">
<div class="bg-white p-6 rounded-lg shadow-md mb-8">
  <h2 class="text-2xl font-semibold mb-4 text-gray-700">Add a New Task</h2>
  <form method="POST" class="space-y-4">
    <input name="name" placeholder="Task Name" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
    <textarea name="description" placeholder="Description" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
    <input type="date" name="due_date" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
    <button class="w-full bg-green-700 text-white font-semibold py-3 rounded-lg shadow hover:shadow-xl transition">Add Task</button>
  </form>
</div>

<div id="completedTasks" data-value="{{ completed_tasks }}"></div>
<div id="incompletedTasks" data-value="{{ incompleted_tasks }}"></div>
<div id="dayCounts" data-value='{{ day_counts | tojson }}'></div>
<div id="mostProductiveDay" data-value="{{ most_productive_day }}" hidden></div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
  <div class="bg-white p-6 rounded-lg shadow-lg">
    <h3 class="text-xl font-semibold mb-4 text-gray-700">Completion Status</h3>
    <canvas id="completionChart" style="width:25%; height:250px;"></canvas>
  </div>
  <div class="bg-white p-6 rounded-lg shadow-lg">
    <h3 class="text-xl font-semibold mb-4 text-gray-700">Most Productive Day</h3>
    <canvas id="productiveChart" style="width:100%; height:650px;"></canvas>
  </div>
</div>

<h2 class="text-2xl font-bold text-black mb-4">Your Tasks</h2>
<ul class="space-y-4">
  {% for task in tasks %}
  {% if not task.completed %}
    <div class="p-4 rounded-lg border shadow-sm flex justify-between items-start hover:shadow-md transition bg-white">
      <div>
        <h3 class="font-semibold text-lg text-gray-800">{{ task.name }}</h3>
        {% if task.due_date %} <p class="text-sm text-gray-500 mb-1">Due: {{ task.due_date.strftime('%Y-%m-%d') }}</p> {% endif %}
        <p class="text-gray-600">{{ task.description }}</p>
      </div>
      <div class="flex gap-4">
        <form method="POST" action="{{ url_for('complete', task_id=task.id) }}">
          <button class="text-green-600 hover:text-green-800" title="Mark as done">Task Completed ?</button>
        </form>
        <form method="POST" action="{{ url_for('delete', task_id=task.id) }}">
          <button class="text-red-600 hover:text-red-800" title="Delete">Delete</button>
        </form>
      </div>
    </div>
  {% endif %}
  {% endfor %}
</ul>

<h2 class="text-2xl font-bold text-black mb-4 mt-6">Completed Tasks</h2>
<div class="grid gap-2">
  {% for task in tasks if task.completed %}
    <div class="p-4 border rounded bg-gray-100 text-gray-600">
      <p class="font-semibold">{{ task.name }}</p>
      <p class="text-sm">Completed at: {{ task.completed_at.strftime('%Y-%m-%d %H:%M') if task.completed_at else 'N/A' }}</p>
    </div>
  {% endfor %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const completedTasks = parseInt(document.getElementById('completedTasks').dataset.value);
    const incompletedTasks = parseInt(document.getElementById('incompletedTasks').dataset.value);
    const dayData = JSON.parse(document.getElementById('dayCounts').dataset.value);
    const mostProductiveDay = document.getElementById('mostProductiveDay').dataset.value;

    const ctx1 = document.getElementById('completionChart').getContext('2d');
    new Chart(ctx1, {
      type: 'doughnut',
      data: {
        labels: ['Completed', 'Incomplete'],
        datasets: [{
          label: 'Tasks',
          data: [completedTasks, incompletedTasks],
          backgroundColor: ['#4CAF50', '#F44336']
        }]
      }
    });

    const days = Object.keys(dayData);
    const counts = Object.values(dayData);
    const barColors = days.map(day => day === mostProductiveDay ? '#FFC107' : '#2196F3');

    const ctx2 = document.getElementById('productiveChart').getContext('2d');
    new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: days,
        datasets: [{
          label: 'Tasks Completed',
          data: counts,
          backgroundColor: barColors
        }]
      },
      options: {
        plugins: {
          title: {
            display: true,
            text: `Most Productive Day: ${mostProductiveDay}`
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  });
</script>
</div>
{% endblock %}
